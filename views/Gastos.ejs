<head>
    <title>Gastos</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- link de bootstrap -->
    <link href="/Enlaces/links/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
   <!--  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous"> -->
    <!-- link de script -->
     <!-- link de icono ventana -->
     <link rel="shortcut icon" type="image/png" href="/img/icono.png">
    <!-- link css -->
    <link rel="stylesheet" href="/css/gastos.css">
    
</head>
<body>
    <%- include ('barra_nav')%>
    <h3> Gastos</h3>

    <div class="container">
        <div class="row">
            <div class=" col-md-12 row p-2">
                <div class="col-md-12">
                    <div class="col-md-2">
                    <label class="form-label">Fecha Gasto</label>
                    <input class="form-control" type="date" name="fecha" id="fecha">
                    </div>
                    <div class="col-md-6">
                    <label  class="form-label">Tipo de Gastos</label>
                    <select class="form-select" id="tipo" aria-label="Default select example">
                        <option selected>Seleccione El Concepto</option>
                        <option >Servicios</option>
                        <option >Gastos Generales</option>
                        <option >Otros</option>
                      </select>
                    </div>
                    <div class="col-md-12">
                        <label for="exampleFormControlTextarea1" class="form-label">Descripción</label>
                        <textarea class="form-control" id="Concepto" rows="3"></textarea>
                    </div>

                    <div class="col-md-8">
                        <div class="col-6">
                            <label  class="form-label">Valor</label>
                            <input type="text" onkeyup="format(this)" onchange="format(this)" id="total" class="form-control"  aria-label="First name" placeholder="$"><br>
                        </div>
                        
                    </div>
                     
 
                </div>
                <div class="row">
                    <div class="col" ></div>
                    <div class="col-md-4">
                        <div class="d-grid">
                            <button id="guardar" class="btn btn-light btn-lg" onclick="Guardar();" type="button">Guardar Gasto</button>
                        </div>

                    </div>
                    <div class="col" >
                        <input id="boton" class="btn btn-outline-warning" type="submit"value="Mostrar Mas..."onclick="Mostrar_ocultar()"/>
                    </div>
                </div>

              
              


            </div>
        </div>

    </div>
 <!-- tabla de historial de gastos -->
 <div class="container" id="caja">
    <div><h3>Historial de Gastos</h3></div>
    <table  class="table table-hover">
        <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">Tipo de Gasto</th>
                <th scope="col">Concepto</th>
                <th scope="col">Fecha</th>
                <th scope="col">Total Gasto</th>
                <th scope="col">&#9940</th>
                
            </tr>
        </thead>
        <tbody id="tablaGasto">
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </tbody>
        <tfoot></tfoot>
    </table>


</div>

</body>
 <!-- otro para alert2 -->
 <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
//funciones para ocultar la tabla de gastos 
Ocultar();
    function Mostrar(){
        document.getElementById('caja').style.display='block';

        listar_egreso();
    }
    function Ocultar(){
        document.getElementById('caja').style.display='none';
    }
    
    function Mostrar_ocultar(){
        var caja = document.getElementById('caja');

        if(caja.style.display == "none"){
           Mostrar();
            document.getElementById('boton').value="Ocultar"
        }
        else{
            Ocultar();
            document.getElementById('boton').value="Mostrar Mas..."
        }
    }
//funcion para guardar gastos
    function Guardar(){
        var fechaactual=document.getElementById('fecha').value;
        var tipo=document.getElementById('tipo').value;
        var Concepto=document.getElementById('Concepto').value;
        var total=document.getElementById('total').value;
        total=total.replace('.','');


        if(tipo==='Seleccione El Concepto'){
            alert('El campo de tipo de gasto es obligatorio')
           document.getElementById('tipo').focus();
           return false;
        }
        if(Concepto==''){
            alert('El campo de Descripción es obligatorio')
           document.getElementById('Concepto').focus();
           return false;
        }
        if(total==''){
            alert('El campo de Valor es obligatorio')
           document.getElementById('total').focus();
           return false;
        }

        const datos= new URLSearchParams();

        datos.append('fecha',fechaactual);
        datos.append('tipo',tipo);
        datos.append('Concepto',Concepto);
        datos.append('total',total);

        fetch('/Gastos/guardargastos',{
            method:'post',
            body:datos
        })
        .then(res=>res.text())
        .then(data=>{

            alert(data);
            document.getElementById('tipo').value='';
            document.getElementById('Concepto').value='';
            document.getElementById('total').value='';

        });
        listar_egreso();
       
    }
/* funcion para agregar puntuación a los valores */
    function format(input)
    {
    var num = input.value.replace(/\./g,'');
    if(!isNaN(num)){
    num = num.toString().split('').reverse().join('').replace(/(?=\d*\.?)(\d{3})/g,'$1.');
    num = num.split('').reverse().join('').replace(/^[\.]/,'');
    input.value = num;
    }
    
    else{ alert('Solo se permiten numeros');
    input.value = input.value.replace(/[^\d\.]*/g,'');
    }
    }



    // Fecha
    fechaactual();
     function fechaactual(){
     
      var fecha = new Date(); //Fecha actual
      var ano = fecha.getFullYear(); //obteniendo año
      var mes = fecha.getMonth()+1; //obteniendo mes
      var dia = fecha.getDate(); //obteniendo dia
      if(dia<10)
        dia='0'+dia; //agrega cero si el menor de 10
      if(mes<10)
        mes='0'+mes //agrega cero si el menor de 10
     
    
      document.getElementById('fecha').value = ano + '-' + mes + '-' + dia;
    }
 //listar historial de gastos 
 listar_egreso();
 function listar_egreso(){

const formatterPeso = new Intl.NumberFormat('es-CO', {
  style: 'currency',
  currency: 'COP',
  minimumFractionDigits: 0
})

  fetch('/Gastos/listar_egreso',{
    method:'get'

})
.then(resp=>resp.json())
.then(data=>{
 



  var html='';
  for (var i in data){

        html+=`<tr><td>${data[i].idegresos}</td>
          
          <td>${data[i].tipo}</td>
          <td>${data[i].concepto}</td>
          <td>${data[i].dates}</td>
          <td>${formatterPeso.format(data[i].valor_gasto)}</td>
          <td> </button><a class='btn btn-outline-danger' href ='javascript:Eliminar (${data[i].idegresos})'title= 'Eliminar' >&#9940</a></td>
          
          
          </tr>`;
          
    }
   
   
    document.getElementById("tablaGasto").innerHTML = html;
   
  
});
}


//funcion de eliminar Gasto
function Eliminar(idegresos) {
  
  
  Swal.fire({
    title: '¡Eliminar!',
    text: "¿Esta seguro de Eliminar los Datos?",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#008000',
    cancelButtonColor: '#d33',
    confirmButtonText: 'Si, Borrar!'
  }).then((result) => {
    if (result.isConfirmed) {
      Swal.fire(
        'Eliminado!',
        'Se Eliminaron los Datos con Éxito .',
        'success'
      )
  
      const datos = new URLSearchParams();
  
      datos.append('idegresos', idegresos);
  
      fetch('Gastos/Eliminar', {
        method: 'delete',
        body: datos
      })
        .then(resp => resp.text())
        .then(data => {
  
  
   
  
  
      //redirect();
      //window.location = "http://localhost:4000/Reportes";
      listar_egreso();
        
        });
  
  
    }
  })
  

  
  }




</script>
